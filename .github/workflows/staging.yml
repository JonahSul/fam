name: ğŸ­ Staging & Preview Deployments

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mobile_app/montanagent/**'
    types: [opened, synchronize, reopened, closed]
  push:
    branches: [ develop, 'feature/**', 'hotfix/**' ]
    paths:
      - 'mobile_app/montanagent/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy for preview'
        required: true
        default: 'develop'
        type: string

permissions:
  contents: read
  checks: write
  statuses: write
  deployments: write
  pull-requests: write

env:
  FLUTTER_VERSION: '3.35.4'
  WORKING_DIRECTORY: ./mobile_app/montanagent

jobs:
  # Stage 1: Build and Test (ONCE)
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    outputs:
      build-success: ${{ steps.build.outcome == 'success' }}
      test-success: ${{ steps.test.outcome == 'success' }}
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ•µï¸ Analyze project source
        run: flutter analyze --fatal-infos

      - name: ğŸ§ª Run tests
        id: test
        run: flutter test --coverage --test-randomize-ordering-seed random

      - name: ğŸ—ï¸ Build web for deployment
        id: build
        run: |
          flutter build web \
            --release \
            --wasm \
            --dart-define=ENVIRONMENT=preview \
            --dart-define=API_BASE_URL=https://api-staging.montanagent.com

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: steps.build.outcome == 'success'
        with:
          name: web-build-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/build/web
          retention-days: 7

  # Stage 2: Deploy Preview (Uses build artifact)
  deploy-preview:
    name: ğŸš€ Deploy Preview
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.outputs.build-success == 'success'
    outputs:
      preview-url: ${{ steps.deploy.outputs.url }}
      details-url: ${{ steps.deploy.outputs.details_url }}
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/build/web

      - name: ğŸš€ Deploy to Firebase Preview
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: preview-${{ github.event.number || github.ref_name }}
          expires: 7d
          entryPoint: ${{ env.WORKING_DIRECTORY }}

      - name: ï¿½ Save deployment info
        run: |
          echo "## ğŸš€ Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "Details URL: ${{ steps.deploy.outputs.details_url }}" >> $GITHUB_STEP_SUMMARY
          echo "Channel ID: preview-${{ github.event.number || github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Stage 3: Quality Assurance (Parallel tests on deployed preview)
  visual-testing:
    name: ğŸ‘ï¸ Visual Testing
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-preview]
    if: needs.deploy-preview.outputs.preview-url != ''
    
    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŒ Setup Node.js for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: ğŸ­ Run visual tests
        env:
          PREVIEW_URL: ${{ needs.deploy-preview.outputs.preview-url }}
        run: |
          echo "ğŸ” Testing URL: $PREVIEW_URL"
          
          cat > visual-test.js << EOF
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            
            try {
              console.log('ğŸŒ Navigating to: $PREVIEW_URL');
              
              await page.goto('$PREVIEW_URL', { 
                waitUntil: 'networkidle',
                timeout: 30000 
              });
              
              await page.waitForTimeout(5000);
              
              await page.screenshot({ 
                path: 'preview-screenshot.png', 
                fullPage: true 
              });
              
              console.log('âœ… Visual test completed successfully');
            } catch (error) {
              console.error('âŒ Visual test failed:', error.message);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF
          
          node visual-test.js

      - name: ğŸ“¤ Upload screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-${{ github.sha }}
          path: preview-screenshot.png
          retention-days: 7

  performance-testing:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-preview]
    if: needs.deploy-preview.outputs.preview-url != ''
    
    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŒ Setup Node.js for Lighthouse
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: ğŸƒ Run Lighthouse audit
        env:
          PREVIEW_URL: ${{ needs.deploy-preview.outputs.preview-url }}
        run: |
          echo "ğŸ” Running Lighthouse audit on: $PREVIEW_URL"
          
          lhci collect \
            --url="$PREVIEW_URL" \
            --numberOfRuns=3
          
          lhci upload \
            --target=temporary-public-storage

      - name: ğŸ“Š Performance summary
        run: |
          echo "## âš¡ Performance Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL: ${{ needs.deploy-preview.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "Lighthouse audit completed with 3 runs for accuracy." >> $GITHUB_STEP_SUMMARY

  # Stage 4: Deploy to Staging (Only on develop branch)
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-test, visual-testing, performance-testing]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/build/web

      - name: ğŸš€ Deploy to Firebase Staging
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: live
          entryPoint: ${{ env.WORKING_DIRECTORY }}

  # Comment on PR with preview info
  pr-comment:
    name: ğŸ’¬ PR Preview Comment
    runs-on: ubuntu-latest
    needs: [deploy-preview, visual-testing, performance-testing]
    if: github.event_name == 'pull_request' && needs.deploy-preview.outputs.preview-url != ''
    
    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ­ Preview Deployment')
            );
            
            const commentBody = `## ğŸ­ Preview Deployment
            
            | ğŸ“Š **Status** | âœ… **Ready** |
            |---|---|
            | ğŸŒ **Preview URL** | [${{ needs.deploy-preview.outputs.preview-url }}](${{ needs.deploy-preview.outputs.preview-url }}) |
            | ğŸ¯ **Environment** | Preview |
            | ğŸ”„ **Auto-refresh** | 7 days |
            | ğŸ“± **Platform** | Web |
            
            ### ğŸ§ª Test Results
            - âœ… Build successful
            - âœ… Visual regression testing completed
            - âœ… Performance audit completed
            
            ### ğŸ“ Instructions
            1. Click the preview URL to test the changes
            2. The preview will auto-update on new commits
            3. Preview expires in 7 days
            
            <sub>âš¡ Generated by GitHub Actions</sub>`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  # Cleanup preview on PR close
  cleanup-preview:
    name: ğŸ§¹ Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§¹ Delete preview channel
        run: |
          # Install Firebase CLI
          npm install -g firebase-tools
          
          # Setup credentials
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=firebase-key.json
          
          # Delete preview channel
          firebase use ${{ secrets.FIREBASE_PROJECT_ID }}
          firebase hosting:channel:delete preview-${{ github.event.number }} --force || true

      - name: ğŸ’¬ Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ­ Preview Deployment')
            );
            
            if (botComment) {
              const updatedBody = botComment.body.replace(
                '| ğŸ“Š **Status** | âœ… **Ready** |',
                '| ğŸ“Š **Status** | ğŸ—‘ï¸ **Cleaned up** |'
              );
              
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: updatedBody + '\n\n> âœ… Preview environment cleaned up after PR closure.'
              });
            }

  # Staging environment health check
  staging-health-check:
    name: ğŸ¥ Staging Health Check
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: ğŸ¥ Check staging health
        run: |
          STAGING_URL="https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          
          # Wait for deployment
          sleep 30
          
          # Check health
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Staging health check failed. HTTP code: $HTTP_CODE"
            exit 1
          fi
          
          echo "âœ… Staging environment is healthy"
          echo "ğŸŒ Staging URL: $STAGING_URL" >> $GITHUB_STEP_SUMMARY
          firebase use ${{ secrets.FIREBASE_PROJECT_ID }}
          firebase hosting:channel:delete preview-${{ github.event.number }} --force || true

      - name: ğŸ’¬ Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ­ Preview Deployment')
            );
            
            if (botComment) {
              const updatedBody = botComment.body.replace(
                '| ğŸ“Š **Status** | âœ… **Ready** |',
                '| ğŸ“Š **Status** | ğŸ—‘ï¸ **Cleaned up** |'
              );
              
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: updatedBody + '\n\n> âœ… Preview environment cleaned up after PR closure.'
              });
            }

  # Staging environment health check
  staging-health-check:
    name: ğŸ¥ Staging Health Check
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: ğŸ¥ Check staging health
        run: |
          STAGING_URL="https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          
          # Wait for deployment
          sleep 30
          
          # Check health
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Staging health check failed. HTTP code: $HTTP_CODE"
            exit 1
          fi
          
          echo "âœ… Staging environment is healthy"
          echo "ğŸŒ Staging URL: $STAGING_URL" >> $GITHUB_STEP_SUMMARY
